services:
  # Single Web Service - All services run together
  # Next.js web app is the main entry point (exposed to internet)
  # Other services run on localhost ports
  - type: web
    name: tsg-logistics
    env: node
    plan: starter
    buildCommand: NODE_ENV=development npm install && npm run build:all
    startCommand: chmod +x scripts/start-render.sh && bash scripts/start-render.sh
    envVars:
      - key: NODE_ENV
        value: production
      # Orders Service (runs on localhost:4001)
      # Uses DATABASE_URL with ?schema=orders if ORDERS_DATABASE_URL not set
      - key: ORDERS_PORT
        value: "4001"
      # Vendor Service (runs on localhost:4002)
      # Uses DATABASE_URL with ?schema=vendors if VENDOR_DATABASE_URL not set
      - key: VENDOR_PORT
        value: "4002"
      # Wallet Service (runs on localhost:4003)
      # Uses DATABASE_URL with ?schema=wallet if WALLET_DATABASE_URL not set
      - key: WALLET_PORT
        value: "4003"
      # API Gateway (runs on localhost:4000, proxied by Next.js)
      - key: GATEWAY_PORT
        value: "4000"
      - key: ORDERS_SERVICE_URL
        value: http://localhost:4001
      - key: VENDOR_SERVICE_URL
        value: http://localhost:4002
      - key: WALLET_SERVICE_URL
        value: http://localhost:4003
      - key: CORS_ORIGINS
        value: https://tsg-logistics.onrender.com
      - key: TELEMETRY_CHANNEL
        value: telemetry:gateway:events
      # Web App (Next.js - main entry point, runs on Render's assigned PORT)
      - key: NEXT_PUBLIC_GATEWAY_URL
        value: http://localhost:4000
      - key: WEB_DATABASE_URL
        sync: false
      - key: DATABASE_URL
        sync: false
      - key: TELEMETRY_CHANNEL
        value: telemetry:gateway:events
      - key: AUTH_SECRET
        generateValue: true
